# Login Service

This is a microsevice that provides login and password reset functionality.
It communicates with a PostgreSQL database to authenticate and modify users. It also signs JWT tokens that prove the identity of a user.

This service implements the Login API and Password Reset API as specified in [docs/apis](https://github.com/IV1201-Group-2/docs/blob/main/apis).

## Project Setup

Make sure you have Go 1.22 or newer and the Heroku CLI client installed before proceeding. To run the tests, Docker is also required.

#### Setting up a development environment

A local Postgres database is required to run the service. You can set it up by using the schema in the shared database repository ([database/schema.sql](https://github.com/IV1201-Group-2/database/blob/main/schema.sql)).

```bash
# Install dependencies
go mod download
# Set up environment variables
export JWT_SECRET=testsecret
export DATABASE_URL=postgres://name:pass@localhost:5432/login
export PORT=8080
# Start the server
go run .
```

#### Linting

The recommended linter is golangci-lint. Follow the installation instructions at [https://golangci-lint.run/usage/install](https://golangci-lint.run/usage/install).

```bash
# Run linters
golangci-lint run
# Run linters and fix some errors automatically
golangci-lint run --fix
```

#### Testing

Tests are located in the tests directory and can be run with `go test './tests/...'`.

To get a test coverage report:

```bash
# Create directory for test output
mkdir -p output
# Build a coverage profile for all packages in the current directory
go test -coverpkg='./...' -coverprofile=output/profile.cov './tests/...'
# Generate a text file showing the coverage of all functions
go tool cover -func output/profile.cov -o output/functions.txt
# Generate a detailed report showing all tested and untested lines
go tool cover -html output/profile.cov -o output/coverage.html
```

#### Deploying to Heroku

The service has the Go buildpack configured in app.json. This means that dependency management and building can be done automatically by Heroku.

Start by setting up the environment variables in Heroku and then push the repository to your Heroku app.

```bash
# Associate git repo with your app
heroku git:remote -a login-service-my-app
# Push to Heroku
git push heroku main
# View logs
heroku logs --tail -a login-service-my-app
```

### Environment Variables

-   Required:

    -   `JWT_SECRET` - The signing key for JWT tokens generated by this service
    -   `DATABASE_URL` - Connection string for a Postgres database (example: `postgres://name:pass@localhost:5432/login`)
    -   `PORT` - Port that the HTTP server should be hosted on

-   Optional:
    -   `DATABASE_MAX_CONNECTIONS` - Specifies how many connections can be active in the database connection pool at the same time (useful if running on a database with limits such as Heroku-managed Postgres)
    -   `LOG_LEVEL` - Specifies the log level of the application ("debug", "info", "warn", etc). Default: "info"
    -   `LOG_FILE` - Specifies the file that logs should be output to. Default: "" (stdout)

### Directory Structure

```text
ðŸ“¦
â”œâ”€Â .github
â”‚Â Â â””â”€Â workflows    - Contains runners for continous integration
â”œâ”€Â api             - Contains code for API routing and user input validation
â”œâ”€Â database        - Contains code for connecting to the database and querying user information
â”œâ”€Â logging         - Contains code that integrates the Echo framework with Logrus
â”œâ”€Â model           - Contains structures that model API and user data
â”œâ”€Â service         - Contains code to authenticate users and sign JWT tokens
â””â”€Â tests           - Contains test code and test SQL schema
Â Â Â â”œâ”€Â api          - Contains unit tests for the API layer
Â Â Â â”œâ”€Â database     - Contains unit tests for the database layer
Â Â Â â”œâ”€Â service      - Contains unit tests for the service layer
```
